<!doctype html>
<html>

<head>
    <script src="pixi-imports/pixijs.js"></script>
    <script src="pixi-imports/@pixi.js"></script>
</head>

<body>
    <script>
        let sprite;
        const renderer = PIXI.autoDetectRenderer({
            antialias: true,
            autoDensity: true,
            resolution: window.devicePixelRatio || 1,
            width: 1440,
            height: 672,
        });
        window.addEventListener('keydown', handleKeyPress)
        let stage;
        let tilemap;
        let frame = 0;

        document.body.appendChild(renderer.view);

        const loader = new PIXI.Loader();

        loader.add('atlas', '/assets/tilemap/atlas.json');


        //Variable for 
        const resources = loader.resources;
        const size = 32;

        // Calculate the dimensions of the tilemap to build
        const pxW = renderer.screen.width;
        const pxH = renderer.screen.height;
        const tileW = pxW / size;
        const tileH = pxH / size;


        loader.load((_, resources) => {
            // Setup tilemap scene
            stage = new PIXI.Container();
            tilemap = new PIXI.tilemap.CompositeTilemap();
            stage.addChild(tilemap);

            // Setup rendering loop
            PIXI.Ticker.shared.add(() => renderer.render(stage));

            makeTilemap();
        });

        function makeTilemap() {
            // Clear the tilemap, in case it is being reused.
            tilemap.clear();

            // Fill the scene with grass and sparse rocks 
            for (let i = 0; i < tileW * 4; i++) {
                for (let j = 0; j < tileH * 4; j++) {
                    let math = Math.random() * 100;
                    if (math < 90) {
                        tilemap.tile(
                            'grass.png',
                            i * size,
                            j * size,
                        );
                    } else {
                        tilemap.tile(
                            'tough.png',
                            i * size,
                            j * size,
                        );
                    }

                }
            }

            // Make Sprite Tile
            sprite = PIXI.Sprite.from('chest.png');
            stage.addChild(sprite);
            sprite.x = tileW / 2 * size;
            sprite.y = tileH / 2 * size;
        }



        //Add event listener to keydown
        window.addEventListener('keydown', handleKeyPress)
        // Takes an event and moves the canvas if it the key is one of the following: WASD
        function handleKeyPress(evt) {
            if (evt.which === 68) {
                if (tilemap.x > -5008)
                    tilemap.x -= 16
                console.log("Tilemap " + tilemap.x + ", " + tilemap.y)
                console.log("Sprite " + sprite.x + ", " + sprite.y)
            }
            if (evt.which === 65) {
                if (sprite.x > tilemap.x) {
                    tilemap.x += 16
                    console.log("Tilemap " + tilemap.x + ", " + tilemap.y)
                    console.log("Sprite " + sprite.x + ", " + sprite.y)
                }
            }
            if (evt.which === 87) {
                if (tilemap.y < sprite.y) {
                    tilemap.y += 16
                    console.log("Tilemap " + tilemap.x + ", " + tilemap.y)
                    console.log("Sprite " + sprite.x + ", " + sprite.y)
                }
            }
            if (evt.which === 83) {
                if (tilemap.y > -2320) {
                    tilemap.y -= 16
                    console.log("Tilemap " + tilemap.x + ", " + tilemap.y)
                    console.log("Sprite " + sprite.x + ", " + sprite.y)
                }
            }
        }
    </script>
</body>

</html>